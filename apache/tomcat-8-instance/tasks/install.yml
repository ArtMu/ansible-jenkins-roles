- name: INSTALL | CREATE CATALINA_BASE
  # =====================================================================
  action: file
  args:
    path: "{{catalina_base}}"
    state: "directory"
    mode: "0700"

- name: INSTALL | PREPARE TOMCAT STRUCTURE (DIRECTORIES)
  # =====================================================================
  action: file
  args:
      path: "{{catalina_base}}/{{item}}"
      state: "directory"
  with_items:
      - "bin"
      - "webapps"
      - "work"
      - "temp"
      - "logs"
      - "conf"

- name: INSTALL | PREPARE TOMCAT STRUCTURE (COPY)
  # =====================================================================
  command: cp "{{catalina_home}}/{{item}}" "{{catalina_base}}/{{item}}"
  args:
    creates: "{{catalina_base}}/{{item}}"
  # action: copy
  # args:
  #     dest: "{{catalina_home}}/{{item}}"
  #     src: "{{catalina_home}}/apache-tomcat-{{apache_tomcat_download_version}}/{{item}}"
  #     remote_src: True
  with_items:
      - "conf/catalina.policy"
      - "conf/catalina.properties"
      - "conf/context.xml"
      - "conf/logging.properties"
      - "conf/server.xml"
      - "conf/tomcat-users.xml"
      - "conf/web.xml"

- name: INSTALL | PREPARE CONTROL SCRIPTS AND CONFIGURATION
  # =====================================================================
  template:
  args:
    src: "{{item}}"
    dest: "{{catalina_base}}/{{item}}"
    mode: 0755
  with_items:
      - "bin/startup.sh"
      - "bin/shutdown.sh"
      - "bin/catalina.sh"
      - "bin/setenv.sh"
      - "conf/server.xml"

- name: INSTALL | PREPARE TOMCAT STRUCTURE (MANAGER APPS)
  # =====================================================================
  command: cp -r "{{catalina_home}}/{{item}}" "{{catalina_base}}/webapps/"
  args:
    creates: "{{catalina_base}}/webapps/{{item}}"
  # action: synchronize
  # args:
  #     dest: "{{catalina_home}}/webapps/"
  #     src: "{{catalina_home}}/apache-tomcat-{{apache_tomcat_download_version}}/{{item}}"
  #     remote_src: True
  with_items:
      - "webapps/host-manager"
      - "webapps/manager"
      - "webapps/ROOT"
      - "webapps/examples"
      - "webapps/docs"

- name: INSTALL | START TOMCAT
  # =====================================================================
  command: "nohup {{catalina_base}}/bin/catalina.sh start 2>&1"
  when: apache_tomcat_start == True

- name: INSTALL | WAIT FOR TOMCAT
  # =====================================================================
  wait_for: port=8080 delay={{ startup_delay_s | default(10) }}
  when: apache_tomcat_start == True
